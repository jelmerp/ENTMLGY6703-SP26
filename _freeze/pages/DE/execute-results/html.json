{
  "hash": "d6e6dce00c688c1bfd4eebf2ab5511d3",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"RNA-Seq differential expression analysis\"\nsubtitle: \"Week 4 lab\"\ndate: 2026-02-06\nauthor:\n  - name: Jelmer Poelstra\n    orcid: 0000-0002-3514-7462\n    email: poelstra.1@osu.edu\n    affiliation: \n      - name: CFAES Bioinformatics Core, Ohio State University\n        url: https://mcic.osu.edu/bioinformatics\nother-links:\n  - text: \"Week 4 lecture\"\n    icon: bookmarks\n    href: rnaseq.html\n  - text: \"R homework\"\n    icon: code\n    href: r_homework.html\nexecute: \n  eval: true\n  cache: true\nknitr:\n  opts_chunk:\n    out.width: \"85%\"\n    class-output: styled-output\nproject:\n  execute-dir: project\neditor_options: \n  chunk_output_type: console\nbibliography: ../references.bib\n---\n\n\n\n\n------\n\n<br>\n\n## Introduction\n\n### Recap\n\n[**Last week**](data.qmd), you explored the RNA-Seq reads from @garrigós2025\nand the *Culex pipiens* reference genome files.\n\nIn [**yesterday's lecture**](rnaseq.qmd),\nyou learned about the steps to generate a gene count table from this input data:\n\n1. **Read preprocessing**: QC, trimming, and optionally rRNA removal\n2. **Alignment** of reads to a reference genome\n3. **Quantification** of expression levels by counting alignments\n\n### Today's goals \n\nI have performed the above steps for you already,\nand you will start with an R object that contains the output of step 3 above:\na **gene count table**. Then, you will:\n\n- Explore the data a bit\n- Perform a Principal Component Analysis (PCA)\n- Run a Differential Expression (DE) analysis\n- Extract and visualize the DE results\n\n## Getting set up\n\n### Start an RStudio session at OSC\n\nStart an RStudio session at OSC like we did last week and like you did for this\nweek's homework:\n\n1. Log in to OSC at <https://ondemand.osc.edu>\n2. Click on **`Interactive Apps`** (top bar) and then **`RStudio Server`**\n   (all the way at the bottom)\n3. Fill out the form as follows:\n   - Cluster: **`Cardinal`**\n   - R version: **`4.4.0`**\n   - Project: **`PAS2880`**\n   - Number of hours: **`4`**\n   - Node type: **`any`**\n   - Number of cores: **`2`**\n4. Click the big blue **`Launch`** button at the bottom\n5. Now, you should be sent to a new page with a box at the top for your\n   RStudio Server \"job\", which should initially be \"Queued\" (waiting to start)\n6. Your job should start running very soon,\n   with the top bar of the box turning green and saying \"Running\"\n7. Click **`Connect to RStudio Server`** at the bottom of the box,\n   and an RStudio Server instance will open in a new browser tab.\n   You're ready to go!\n\n### Create an R script\n\nToday, you're going to write most of your code in an R script instead of typing\nit directly in the R console, as explained in the [R homework](r_homework.qmd):\n\n1. Create and open a new R script by clicking\n   **`File`** (top menu bar) \\> **`New File`** \\> **`R Script`**.\n\n2. Save this new script right away by clicking **`File`** \\> **`Save As`**.\n   In the dialog box,\n   you can save it right in the suggested folder (which is your OSC Home folder),\n   or you can make a new folder for this course by clicking \"New Folder\" in\n   the bottom left.\n   Regardless, save the script as **`lab4_DE.R`**\n   (the extension for R scripts is `.R`).\n\n### Load the R packages you will use\n\nAs part of your homework,\nyou installed a few R packages that have functionality you'll need in today's lab.\n\nRecall that R packages behave equivalently to other software/apps in the following way:\nwhile installation is a one-time thing,\nthey need to be loaded in any given session to be used.\nSo, let's start with loading these packages:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(DESeq2)          # For differential expression analysis\nlibrary(EnhancedVolcano) # For creating volcano plots\nlibrary(tidyverse)       # For misc. data manipulation and plotting\n```\n:::\n\n\n\n\n<details><summary>*Click to see expected output*</summary>\n<hr style=\"height:1pt; visibility:hidden;\" />\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n``` regular-r-output\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.1     ✔ stringr   1.5.2\n✔ ggplot2   4.0.0     ✔ tibble    3.3.0\n✔ lubridate 1.9.4     ✔ tidyr     1.3.1\n✔ purrr     1.1.0     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(DESeq2)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n``` regular-r-output\nLoading required package: S4Vectors\nLoading required package: stats4\nLoading required package: BiocGenerics\nLoading required package: generics\n\nAttaching package: 'generics'\n\nThe following object is masked from 'package:lubridate':\n\n    as.difftime\n\nThe following object is masked from 'package:dplyr':\n\n    explain\n\nThe following objects are masked from 'package:base':\n\n    as.difftime, as.factor, as.ordered, intersect, is.element, setdiff,\n    setequal, union\n\n\nAttaching package: 'BiocGenerics'\n\nThe following object is masked from 'package:dplyr':\n\n    combine\n\nThe following objects are masked from 'package:stats':\n\n    IQR, mad, sd, var, xtabs\n\nThe following objects are masked from 'package:base':\n\n    anyDuplicated, aperm, append, as.data.frame, basename, cbind,\n    colnames, dirname, do.call, duplicated, eval, evalq, Filter, Find,\n    get, grep, grepl, is.unsorted, lapply, Map, mapply, match, mget,\n    order, paste, pmax, pmax.int, pmin, pmin.int, Position, rank,\n    rbind, Reduce, rownames, sapply, saveRDS, table, tapply, unique,\n    unsplit, which.max, which.min\n\n\nAttaching package: 'S4Vectors'\n\nThe following objects are masked from 'package:lubridate':\n\n    second, second<-\n\nThe following objects are masked from 'package:dplyr':\n\n    first, rename\n\nThe following object is masked from 'package:tidyr':\n\n    expand\n\nThe following object is masked from 'package:utils':\n\n    findMatches\n\nThe following objects are masked from 'package:base':\n\n    expand.grid, I, unname\n\nLoading required package: IRanges\n\nAttaching package: 'IRanges'\n\nThe following object is masked from 'package:lubridate':\n\n    %within%\n\nThe following objects are masked from 'package:dplyr':\n\n    collapse, desc, slice\n\nThe following object is masked from 'package:purrr':\n\n    reduce\n\nLoading required package: GenomicRanges\nLoading required package: GenomeInfoDb\nLoading required package: SummarizedExperiment\nLoading required package: MatrixGenerics\nLoading required package: matrixStats\n\nAttaching package: 'matrixStats'\n\nThe following object is masked from 'package:dplyr':\n\n    count\n\n\nAttaching package: 'MatrixGenerics'\n\nThe following objects are masked from 'package:matrixStats':\n\n    colAlls, colAnyNAs, colAnys, colAvgsPerRowSet, colCollapse,\n    colCounts, colCummaxs, colCummins, colCumprods, colCumsums,\n    colDiffs, colIQRDiffs, colIQRs, colLogSumExps, colMadDiffs,\n    colMads, colMaxs, colMeans2, colMedians, colMins, colOrderStats,\n    colProds, colQuantiles, colRanges, colRanks, colSdDiffs, colSds,\n    colSums2, colTabulates, colVarDiffs, colVars, colWeightedMads,\n    colWeightedMeans, colWeightedMedians, colWeightedSds,\n    colWeightedVars, rowAlls, rowAnyNAs, rowAnys, rowAvgsPerColSet,\n    rowCollapse, rowCounts, rowCummaxs, rowCummins, rowCumprods,\n    rowCumsums, rowDiffs, rowIQRDiffs, rowIQRs, rowLogSumExps,\n    rowMadDiffs, rowMads, rowMaxs, rowMeans2, rowMedians, rowMins,\n    rowOrderStats, rowProds, rowQuantiles, rowRanges, rowRanks,\n    rowSdDiffs, rowSds, rowSums2, rowTabulates, rowVarDiffs, rowVars,\n    rowWeightedMads, rowWeightedMeans, rowWeightedMedians,\n    rowWeightedSds, rowWeightedVars\n\nLoading required package: Biobase\nWelcome to Bioconductor\n\n    Vignettes contain introductory material; view with\n    'browseVignettes()'. To cite Bioconductor, see\n    'citation(\"Biobase\")', and for packages 'citation(\"pkgname\")'.\n\n\nAttaching package: 'Biobase'\n\nThe following object is masked from 'package:MatrixGenerics':\n\n    rowMedians\n\nThe following objects are masked from 'package:matrixStats':\n\n    anyMissing, rowMedians\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(EnhancedVolcano)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n``` regular-r-output\nLoading required package: ggrepel\n```\n\n\n:::\n:::\n\n\n\n</details>\n\n::: {.callout-important appearance=\"simple\"}\nHere, and with all the code in this lab,\ntype or copy it in your script, and send it to the console from there.\nRecall that you can send code to the console by pressing\n<kbd>Ctrl</kbd> + <kbd>Enter</kbd> (Windows) /\n<kbd>Cmd</kbd> + <kbd>Return</kbd> (Mac).\n:::\n\n## Loading and exploring the data\n\nThe main analyses you'll perform today are a Principal Component Analysis (PCA)\nand a Differential Expression (DE) analysis.\nAn R package that makes this relatively straightforward is **DESeq2**\n(@love2014deseq2, \n[package website](https://bioconductor.org/packages/release/bioc/html/DESeq2.html)),\nwhich you installed as part of your homework, and loaded just now.\n\nDESeq2 has its own \"object type\" (a specific R format type),\nand the first step when working with this package is to create a DESeq2 object.\nI already did this for you, so you can focus on the analysis itself.\nThe object consists of two main parts:\n\n1. **Sample metadata** -- accessed with `colData()`\\\n   A table \"mapping\" samples to the groups they belong (here: treatment, time)\n   \n2. **Count table** -- accessed with `counts()`\\\n   A table with one row per gene, one column per sample, containing the gene counts\n   \nLet's load this DESeq2 object from a file.\nIt's stored in an R-specific format called an RDS file,\nwhich you can load with the `readRDS()` function:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# We give the object the name 'dds' (short for DESeqDataSet)\n# (This is arbitrary and you could call it anything you want - but don't change it here.)\ndds <- readRDS(\"/fs/scratch/PAS2880/ENT6703/results/dds.rds\")\n```\n:::\n\n::: {.cell}\n\n:::\n\n\n\n\nLet's see what's inside this DESeq2 object by simply typing its name:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndds\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\nclass: DESeqDataSet \ndim: 18855 22 \nmetadata(1): version\nassays(1): counts\nrownames(18855): ATP6 ATP8 ... unassigned_gene_8 unassigned_gene_9\nrowData names(0):\ncolnames(22): ERR10802863 ERR10802864 ... ERR10802885 ERR10802886\ncolData names(2): dpi treatment\n```\n\n\n:::\n:::\n\n\n\n\nThat printed a summary of the object, with the following key items:\n\n- **`class`**: The type of R object (here, `DESeqDataSet`)\n- **`dim`**: The dimensions of the count table (genes x samples)\n- **`rownames`**: The row names of the count table (here, gene IDs)\n- **`colnames`**: The column names of the count table (here, sample IDs)\n- **`colData names`**: The column names of the sample metadata table\n  _(`colData` is used as a shorthand for \"column data\", i.e. data associated with_\n  _the columns of the count table, which are the samples)_\n\n### The sample metadata\n\nLast week, we looked at the TSV file with the sample metadata (`metadata/meta.tsv`),\nbut we'll take a closer look at this same sample metadata now.\n   \nIt can be accessed with the `colData()` function,\nwith the name of your DESeq2 object as the function's argument:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncolData(dds)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\nDataFrame with 22 rows and 2 columns\n                 dpi   treatment\n            <factor>    <factor>\nERR10802863        1 control    \nERR10802864        1 cathemerium\nERR10802865        1 relictum   \nERR10802866        1 control    \nERR10802867        1 cathemerium\n...              ...         ...\nERR10802882       10 cathemerium\nERR10802883       10 cathemerium\nERR10802884       10 control    \nERR10802885       10 relictum   \nERR10802886       10 relictum   \n```\n\n\n:::\n:::\n\n\n\n\nThis output only shows the first 5 and last 5 rows with `...` in between.\nTo see the entire table more easily,\nyou can first create a regular dataframe from it:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# This turns the colData() output into a regular data frame and stores it in 'meta':\nmeta <- data.frame(colData(dds))\n```\n:::\n\n\n\n\nAnd then take a look -- e.g. with the `View()` function:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# View() will open the dataframe in a spreadsheet like view\n# Below on this website, it's just printed in full\nView(meta)\n```\n:::\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\n            dpi   treatment\nERR10802863   1     control\nERR10802864   1 cathemerium\nERR10802865   1    relictum\nERR10802866   1     control\nERR10802867   1 cathemerium\nERR10802868   1    relictum\nERR10802869   1     control\nERR10802870   1 cathemerium\nERR10802871   1    relictum\nERR10802874   1    relictum\nERR10802875  10 cathemerium\nERR10802876  10    relictum\nERR10802877  10     control\nERR10802878  10     control\nERR10802879  10 cathemerium\nERR10802880  10    relictum\nERR10802881  10     control\nERR10802882  10 cathemerium\nERR10802883  10 cathemerium\nERR10802884  10     control\nERR10802885  10    relictum\nERR10802886  10    relictum\n```\n\n\n:::\n:::\n\n\n\n\n::: exercise\n#### {{< fa user-edit >}} Exercise: Interpret the metadata\n\nBased on the information in the table, recap the study's experimental design.\nHow many timepoints and treatments are there?\nHow many biological replicates per group?\n:::\n\n### The count table\n\nThe gene count table inside the DESeq2 object can be accessed with the\n`counts()` function:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# We'll wrap it in head() to only see the first 6 rows (genes):\nhead(counts(dds))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\n     ERR10802863 ERR10802864 ERR10802865 ERR10802866 ERR10802867 ERR10802868\nATP6       10275        8255        4103       18615       11625        7967\nATP8           4           3           2           8           7           2\nCOX1       88041       83394       36975      136054      130863       62279\nCOX2        8749        7925        2901       16802       10026        6701\nCOX3       55772       50312       35074       80510       69850       42478\nCYTB       38543       36352       22185       62147       57461       28159\n     ERR10802869 ERR10802870 ERR10802871 ERR10802874 ERR10802875 ERR10802876\nATP6       12788        4408       13648       13834        1346       10032\nATP8           2           0           2           1           3           2\nCOX1      109596      106402      104394       77682       38276       78290\nCOX2       11494        6603       11151        9893        1473       13146\nCOX3       68228       71945       66900       52368       14665       37275\nCYTB       46219       52035       46090       35247       17449       38762\n     ERR10802877 ERR10802878 ERR10802879 ERR10802880 ERR10802881 ERR10802882\nATP6         987        1834        3337        5036        1983       11586\nATP8           0           0           0           3           0          27\nCOX1       17785       32099       64490       63960       50965       76113\nCOX2        1141        1907        3439        8334        2063       12752\nCOX3        8797       15948       26278       29997       17802       35419\nCYTB       11177       22262       34368       33401       25854       43912\n     ERR10802883 ERR10802884 ERR10802885 ERR10802886\nATP6       18821        2792       11749        6682\nATP8          40           0           8           1\nCOX1      108343       65829      107741       94682\nCOX2       19148        2713       17947       10656\nCOX3       51441       24915       50029       47750\nCYTB       57844       34616       50587       51198\n```\n\n\n:::\n:::\n\n\n\n\nThis output may look confusing at a glance.\nOnly the first 6 rows (=genes) are printed, but because the table is quite wide,\nthe output is \"folded\".\nPay attention to the row (gene) names to understand it better.\n\n::: exercise\n#### {{< fa user-edit >}} Exercise: Number of genes and samples in the count table\n\nThe `nrow()` and `ncol()` functions return the number of rows and columns,\nrespectively, of data frames and similar rectangular data formats.\n\nFor example, if you had a data frame called `my_df`,\nthen `nrow(my_df)` would return the number of rows in that data frame.\n\nUse these functions on the count table to double-check the number of genes and\nthe number of samples in the count table.\n:::\n\n### Library sizes\n\nThe total number of gene counts per sample is called the **library size**.\nThis varies among samples for various reasons,\nbut we don't consider these differences to be biologically meaningful.\nFor example, if sample A has 10 million reads and sample B has 20 million reads,\nwe could _not_ conclude that sample B had \"more expression\" or anything like that.\n\n<details><summary>Does this make sense to you, or is it counter-intuitive?\n&nbsp; <span style=\"color:darkolivegreen;\">{{< fa comments >}}</span>\n</summary>\n</details>\n\nHow do the library sizes compare across samples?\nTo see this,\nyou can compute sums for each column (sample) using the `colSums()` function:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncolSums(counts(dds))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\nERR10802863 ERR10802864 ERR10802865 ERR10802866 ERR10802867 ERR10802868 \n   24297245    17177436    22745445    26849403    21471477    17506262 \nERR10802869 ERR10802870 ERR10802871 ERR10802874 ERR10802875 ERR10802876 \n   24299398    25490128    26534405    22194841    18927885    28804150 \nERR10802877 ERR10802878 ERR10802879 ERR10802880 ERR10802881 ERR10802882 \n    9498249    14807513    20667093    23107463    17545375    19088206 \nERR10802883 ERR10802884 ERR10802885 ERR10802886 \n   21418234    19420046    24367372    25452228 \n```\n\n\n:::\n:::\n\n\n\n\nOK, lots of big numbers, so not that easy to read / interpret.\nLet's manipulate that a bit:\n\n- Convert the numbers to whole millions:\n  divide by 1,000,000 and then round with `round()`\n- Sorted the values (samples) from low to high with `sort()`\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsort(round(colSums(counts(dds)) / 1000000))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\nERR10802877 ERR10802878 ERR10802864 ERR10802868 ERR10802881 ERR10802875 \n          9          15          17          18          18          19 \nERR10802882 ERR10802884 ERR10802867 ERR10802879 ERR10802883 ERR10802874 \n         19          19          21          21          21          22 \nERR10802865 ERR10802880 ERR10802863 ERR10802869 ERR10802885 ERR10802870 \n         23          23          24          24          24          25 \nERR10802886 ERR10802866 ERR10802871 ERR10802876 \n         25          27          27          29 \n```\n\n\n:::\n:::\n\n\n\n\n<hr style=\"height:1pt; visibility:hidden;\" />\n\n<details><summary>\nGiven what we just discussed:\nIf one sample has 9 million reads and another 28 million reads,\nwhat implications does this have for comparing gene expression levels between them?\n&nbsp; <span style=\"color:darkolivegreen;\">{{< fa comments >}}</span>\n</summary></details>\n\n::: {.callout-note collapse=\"true\"}\n#### Bonus: How many genes have non-zero counts? _(Click to expand)_\n\nPerhaps surprisingly, the gene count table often contains genes\nwith zero counts across all samples:\nit simply contains all genes in the genome.\nIn this dataset, how many genes have zero counts across all samples?\n\nTo compute this, first note that you can use `rowSums()` to compute total\ncounts per gene.\nThen, you can make use of the following type of construct to count how many\ntimes that sum is greater than a certain number, here 0:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_vec <- c(5, 0, 9)\nmy_vec > 0\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\n[1]  TRUE FALSE  TRUE\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsum(my_vec > 0)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\n[1] 2\n```\n\n\n:::\n:::\n\n\n\n\n<hr style=\"height:1pt; visibility:hidden;\" />\n\nSo, the number of genes with non-zero total counts can be computed like so:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsum(rowSums(counts(dds)) > 0)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\n[1] 17788\n```\n\n\n:::\n:::\n\n\n\n\n<hr style=\"height:1pt; visibility:hidden;\" />\n\n<details><summary>\n{{< fa user-edit >}} Your turn: How many genes have total counts of at least 10?\n*(Click to see the solution)*\n</summary>\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsum(rowSums(counts(dds)) > 9)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\n[1] 16682\n```\n\n\n:::\n:::\n\n\n\n</details>\n\n<details><summary>\n{{< fa user-edit >}} Your turn: How many genes have *mean* counts of at least 10?\n*(Click to see the solution)*\n</summary>\n\nNow you need to divide the count sums by the number of samples (`22`):\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsum(rowSums(counts(dds)) / 22 > 9)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\n[1] 12676\n```\n\n\n:::\n:::\n\n\n\n\nAn even more robust way to do this is to not \"hard-code\" the number of samples (`22`),\nbut to get it programmatically.\nThis is the number of columns, which you can get with `ncol()`\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsum(rowSums(counts(dds)) / ncol(counts(dds)) > 9)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\n[1] 12676\n```\n\n\n:::\n:::\n\n\n\n\n</details>\n:::\n\n## Principal Component Analysis (PCA)\n\nYou will now run a PCA to look for overall patterns of (dis)similarity among samples.\nA PCA summarizes the variation in a high-dimensional dataset\n(here: gene expression levels across many genes)\ninto a few \"principal components\" (PCs) that capture the most variation.\n\nDoing this can help answer questions like:\n\n1. Do the samples cluster by treatment (infection status) and/or time point?\n   If they do, that suggests that these variables have a strong effect on gene expression.\n2. Which of these two variables has a greater effect on overall patterns of gene expression?\n3. Is there an overall *interaction* between these two variables?\n\nBefore running the PCA,\nthe count data should be normalized to account for differences in library size\namong samples and to \"stabilize\" the variance among genes[^4]:\n\n[^4]: Specifically, the point is to remove the correlation among genes between the\n      mean expression level and the variance in expression.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndds_vst <- varianceStabilizingTransformation(dds)\n```\n:::\n\n\n\n\nThe authors of the study did this as well:\n\n> *We carried out a Variance Stabilizing Transformation (VST) of the counts to represent the samples on a PCA plot.*\n\nNext, you can run the PCA and plot the results with a single function call,\n`plotPCA()` from DESeq2:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# The 'intgroup' argument lets you pick the variables (columns) to color samples by\nplotPCA(dds_vst, intgroup = c(\"dpi\", \"treatment\"))\n```\n\n::: {.cell-output .cell-output-stderr}\n\n``` regular-r-output\nusing ntop=500 top features by variance\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n``` warning-r-output\nWarning: `aes_string()` was deprecated in ggplot2 3.0.0.\nℹ Please use tidy evaluation idioms with `aes()`.\nℹ See also `vignette(\"ggplot2-in-packages\")` for more information.\nℹ The deprecated feature was likely used in the DESeq2 package.\n  Please report the issue to the authors.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](DE_files/figure-html/unnamed-chunk-20-1.png){width=85%}\n:::\n:::\n\n\n\n\n::: exercise\n#### {{< fa user-edit >}} Exercise: Interpret the PCA result\n\n1. Based on the above PCA plot, try to answer the three questions asked at the\n   beginning of this PCA section.\n\n2. How does the the PCA plot in the paper (Figure 1) compare?\n   Would you draw similar conclusions or do you see obvious differences?\n\n   <details><summary>*Click to see the paper's Figure 1*</summary>\n   <hr style=\"height:1pt; visibility:hidden;\" />\n  \n   ![](../img/garrigo_PCA.jpeg){fig-align=\"center\" width=\"90%\"}\n  \n   <hr style=\"height:1pt; visibility:hidden;\" />\n   </details>\n:::\n\n<hr style=\"height:1pt; visibility:hidden;\" />\n\nIf you have time, you can pick one of the following bonus exercises to do:\n\n::: exercise\n#### {{< fa user-edit >}} Bonus exercise 1: Number of genes in the PCA\n\nBy default, the PCA run by `plotPCA()` does not summarize the variation\nin _all_ genes, but only in the top 500 most variable genes.\nThis tends to be a good representation of overall patterns,\nbut it can be a good idea to check how robust the results are to this choice.\n\nThe `plotPCA()` function has an argument to change the number of included genes.\n\n1. Figure out what the name of this argument is by check the help for the function\n   _(Hint: run `?plotPCA` in the R console)_\n\n2. Play around with different numbers of included genes\n   (e.g., 100, all genes) and see how this affects the plot\n:::\n\n::: exercise\n#### {{< fa user-edit >}} Bonus exercise 2: Make a better PCA plot\n\nCustomize the PCA plot to make it better-looking and clearer.\n\nFor example, in the plot we made above,\neach combination of time point and treatment has a distinct color.\nBut it would be better to use **point color** only to distinguish one of the variables,\nand **point shape** to distinguish the other variable,\nas was done in the paper's Fig. 1.\n\nTo customize the plot, you'll first need to get the data in a format you can use\nto build the plot from scratch.\nDo this using the `returnData = TRUE` argument of the `plotPCA()` function\n(check the partial solution below if needed).\n\nThen, the plot customization will require some knowledge of _ggplot2_.\nIf you don't know how to do this yet, but still want to try,\nyou can also try to use generative AI (Microsoft Copilot, ChatGPT, etc.)\nto help you write the code.\n\n<details><summary>*Partial solution: getting the dataframe*</summary>\n\nTo be able to customize the plot properly,\nit's best to build it from scratch ourselves,\nrather than using the `plotPCA` function.\nBut then how do we get the input data in the right shape?\n\nA nice trick is that we can use `returnData = TRUE` in the `plotPCA` function,\nto get plot-ready formatted data instead of an actual plot:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npca_df <- plotPCA(\n  dds_vst,\n  ntop = 500,\n  intgroup = c(\"dpi\", \"treatment\"),\n  returnData = TRUE\n  )\n```\n\n::: {.cell-output .cell-output-stderr}\n\n``` regular-r-output\nusing ntop=500 top features by variance\n```\n\n\n:::\n:::\n\n\n\n\n</details>\n\n<details><summary>*Click to see a possible solution*</summary>\n\nThis starts from the `pca_df` dataframe created in the first solution above:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(pca_df) +\n  aes(x = PC1, y = PC2, color = treatment, shape = dpi) +\n  geom_point(size = 5) +\n  scale_color_brewer(palette = \"Dark2\", name = \"Infection status\") +\n  theme_bw(base_size = 13)\n```\n\n::: {.cell-output-display}\n![](DE_files/figure-html/unnamed-chunk-22-1.png){width=85%}\n:::\n:::\n\n\n\n\nFinally, we may want to add the percentage of variance explained by each\nprincipal component (PC) to the axes labels.\nThat can be done as follows:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# First extract and store the percentage of variance explained by different\n# principal components, so you can later add this information to the plot:\npct_var <- round(100 * attr(pca_df, \"percentVar\"), 1)\npct_var\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\n[1] 85.3  3.1\n```\n\n\n:::\n\n```{.r .cell-code}\n# Remake the plot and customize the axes labels:\nggplot(pca_df) + \n  aes(x = PC1, y = PC2, color = treatment, shape = dpi) +\n  geom_point(size = 5) +\n  labs(\n    x = paste0(\"PC1 (\", pct_var[1], \"%)\"),\n    y = paste0(\"PC2 (\", pct_var[2], \"%)\")\n    ) +\n  scale_color_brewer(palette = \"Dark2\", name = \"Infection status\") +\n  theme_bw(base_size = 13)\n```\n\n::: {.cell-output-display}\n![](DE_files/figure-html/unnamed-chunk-23-1.png){width=85%}\n:::\n:::\n\n\n\n</details>\n:::\n\n## Differential Expression (DE) analysis\n\n### Figuring out how to do the analysis\n\nFirst, let's check how the paper's authors did the DE analysis:\n\n> *Then, we used the DESeq2 package (Love et al., 2014) to perform the differential gene expression analysis comparing: (i) P. relictum-infected mosquitoes vs. controls, (ii) P. cathemerium-infected mosquitoes vs. controls, and (iii) P. relictum-infected mosquitoes vs. P. cathemerium-infected mosquitoes.*\n\nThis is not terribly detailed and could be interpreted in a couple of different ways.\nFor example, they may have compared infection statuses by *ignoring* time points\n***or*** by *controlling for* time points in various ways.\n\nIgnoring time would mean analyzing the full dataset (all time points)\nwhile using the infection status as the only \"independent variable\",\ni.e. using the design `~treatment`.\n\n<hr style=\"height:1pt; visibility:hidden;\" />\n\n<details><summary>\nGiven the PCA results, do you think we can ignore the `dpi` variable? Why/why not?\n&nbsp; <span style=\"color:darkolivegreen;\">{{< fa comments >}}</span>\n</summary></details>\n\nControlling for time can be done in two ways:\n\n- An analysis with two independent variables: `~ dpi + treatment`\n- Pairwise comparisons between each combination of `dpi` and `treatment`\n\nIf you take a look at Table 1 with the DE results,\nit should become clearer how they did their analysis:\n\n![](../img/paper_table1.png){fig-align=\"center\" width=\"80%\"}\n\n<details><summary>\nHow do you interpret this:\ndid they run pairwise comparisons or a model with multiple variables?\n&nbsp; <span style=\"color:darkolivegreen;\">{{< fa comments >}}</span>\n</summary></details>\n\nEven pairwise comparisons with more than independent variable can be done in two\nways, but we'll use the most common one, which is to create a single,\ncombined independent variable that is a combination of `dpi` and `treatment`.\n\n### Setting the statistical design\n\nYou will now create a new variable that is a combination of `treatment` and `dpi`,\nand call it `group`.\nFirst, create a vector with these combinations using the `paste()` function:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngroup <- paste(dds$treatment, dds$dpi, sep = \"_\")\ngroup\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\n [1] \"control_1\"      \"cathemerium_1\"  \"relictum_1\"     \"control_1\"     \n [5] \"cathemerium_1\"  \"relictum_1\"     \"control_1\"      \"cathemerium_1\" \n [9] \"relictum_1\"     \"relictum_1\"     \"cathemerium_10\" \"relictum_10\"   \n[13] \"control_10\"     \"control_10\"     \"cathemerium_10\" \"relictum_10\"   \n[17] \"control_10\"     \"cathemerium_10\" \"cathemerium_10\" \"control_10\"    \n[21] \"relictum_10\"    \"relictum_10\"   \n```\n\n\n:::\n:::\n\n\n\n\nNext, turn this into a 'factor' and add it to the DESeq2 object\n(factors are a common R data type for categorical variables,\nand required by DESeq2):\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndds$group <- factor(group)\ndds$group\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\n [1] control_1      cathemerium_1  relictum_1     control_1      cathemerium_1 \n [6] relictum_1     control_1      cathemerium_1  relictum_1     relictum_1    \n[11] cathemerium_10 relictum_10    control_10     control_10     cathemerium_10\n[16] relictum_10    control_10     cathemerium_10 cathemerium_10 control_10    \n[21] relictum_10    relictum_10   \n6 Levels: cathemerium_1 cathemerium_10 control_1 control_10 ... relictum_10\n```\n\n\n:::\n:::\n\n\n\n\nAs a quick sanity check:\nwhich unique values does `group` have, and how many samples are in each?\nUse the `table()` function for this:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(dds$group)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\n\n cathemerium_1 cathemerium_10      control_1     control_10     relictum_1 \n             3              4              3              4              4 \n   relictum_10 \n             4 \n```\n\n\n:::\n:::\n\n\n\n\nLastly, set the analysis design by \"adding\" it to the DESeq2 object:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Note: the symbol before 'group' is a tilde, ~ \ndesign(dds) <- ~ group\n```\n:::\n\n\n\n\nPhew, now you're finally ready to run the DE analysis!\n\n### Running the DE analysis\n\nWhile you had to do a lot of prep to get here,\nactually running the DE analysis is very simple.\nIt's done with the function `DESeq()`,\nwhich _only_ needs to be provided with the DESeq2 object\n(because all the data and also the analysis options are specified in\nthe object itself):\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# (Note that the output is assigned back to the same `dds` object -\n#  the DE results are added to it)\ndds <- DESeq(dds)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n``` regular-r-output\nestimating size factors\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n``` regular-r-output\nestimating dispersions\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n``` regular-r-output\ngene-wise dispersion estimates\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n``` regular-r-output\nmean-dispersion relationship\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n``` regular-r-output\nfinal dispersion estimates\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n``` regular-r-output\nfitting model and testing\n```\n\n\n:::\n:::\n\n\n\n\nThe `DESeq()` function performs a bunch of steps consecutively, to:\n\n1. \"Normalize\" the count data by library size and composition\n2. Estimate of gene-wise variance in counts (\"dispersion\")\n3. Fit the statistical model and calculate the test statistics\n\nA key thing to understand is that above,\nDESeq2 automatically performed pairwise comparisons between\neach of the (6) levels of the `group` variable.\nThis means that for any individual gene, it tested whether the gene is\ndifferentially expressed\n**separately for each of these (15) pairwise comparisons**.\n\n::: exercise\n#### {{< fa user-edit >}} Exercise: Pairwise comparisons\n\nWould you say we are interested in all 15 pairwise comparisons?\n\nIf you'd like to see all possible pairwise comparisons, use the following R code:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncombn(unique(group), m = 2)\n```\n:::\n\n\n\n\n<details><summary>_Click to show the output of the code above_</summary>\n<hr style=\"height:1pt; visibility:hidden;\" />\n\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\n     [,1]            [,2]         [,3]             [,4]          [,5]        \n[1,] \"control_1\"     \"control_1\"  \"control_1\"      \"control_1\"   \"control_1\" \n[2,] \"cathemerium_1\" \"relictum_1\" \"cathemerium_10\" \"relictum_10\" \"control_10\"\n     [,6]            [,7]             [,8]            [,9]           \n[1,] \"cathemerium_1\" \"cathemerium_1\"  \"cathemerium_1\" \"cathemerium_1\"\n[2,] \"relictum_1\"    \"cathemerium_10\" \"relictum_10\"   \"control_10\"   \n     [,10]            [,11]         [,12]        [,13]           \n[1,] \"relictum_1\"     \"relictum_1\"  \"relictum_1\" \"cathemerium_10\"\n[2,] \"cathemerium_10\" \"relictum_10\" \"control_10\" \"relictum_10\"   \n     [,14]            [,15]        \n[1,] \"cathemerium_10\" \"relictum_10\"\n[2,] \"control_10\"     \"control_10\" \n```\n\n\n:::\n:::\n\n\n\n\nEach \"column\" in this ouput represents one pairwise comparison.\n\n</details>\n\n:::\n\n::: callout-note\n## Summary of statistical considerations for the DE analysis\n\n1. **Gene count normalization** -- to fairly compare samples, raw gene counts must be adjusted:\n   - By *library size*, the total number of gene counts per sample\n   - By *library composition*, e.g. to correct for extremely abundant genes\n     that \"steal\" most of a sample's counts\n\n2. **Probability distribution of the count data**\n   - Gene counts have a distribution similar to Poisson but with higher variance\n     (the *negative binomial distribution* is typically used)\n   - Variance estimates are gene-specific but \"borrow\" information from other genes ---\\\n     necessary in practice, but can make the analysis sensitive to false\n     positives due to outliers (!)\n\n3. **Multiple-testing correction**\n   - 10,000+ genes are independently tested during a DE analysis,\n     so multiple testing correction is needed!\n   - The most common approach is the **Benjamini-Hochberg** (BH) method\n     _([explanatory video](https://www.youtube.com/watch?v=K8LQSvtjcEo))_\n:::\n\n## Extracting the DE results\n\nDESeq2 stores the results as a separate table for each pairwise comparison.\nNow, you'll extract one of these tables.\n\n### The results table\n\nYou can extract the results for one pairwise comparison\n(which DESeq2 refers to as a **contrast**) at a time,\nby specifying it with the `contrast` argument as a vector of length 3:\n\n1. The independent variable of interest (here, `group`)\n2. The first (reference) level of the independent variable (in the example below, `relictum_1`)\n3. The second level of the independent variable (in the example below, `control_1`)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nres_rc1 <- results(dds, contrast = c(\"group\", \"relictum_1\", \"control_1\"))\n\nhead(res_rc1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\nlog2 fold change (MLE): group relictum_1 vs control_1 \nWald test p-value: group relictum_1 vs control_1 \nDataFrame with 6 rows and 6 columns\n       baseMean log2FoldChange     lfcSE      stat    pvalue      padj\n      <numeric>      <numeric> <numeric> <numeric> <numeric> <numeric>\nATP6  7658.0445      -0.416305  0.609133 -0.683438 0.4943300  0.776172\nATP8     4.9196      -1.311116  1.388811 -0.944057 0.3451408        NA\nCOX1 75166.8670      -0.590935  0.282075 -2.094958 0.0361747  0.208045\nCOX2  7807.1848      -0.610152  0.578401 -1.054893 0.2914743  0.615249\nCOX3 41037.7359      -0.400173  0.251760 -1.589498 0.1119479  0.388880\nCYTB 36916.6130      -0.501653  0.261927 -1.915242 0.0554617  0.266528\n```\n\n\n:::\n:::\n\n\n\n\nWhat do the columns in this table contain?\n\n- **`baseMean`**: Mean expression level across all samples\n- **`log2FoldChange`**: The \"log~2~-fold change\" of gene counts between the compared levels\n- **`lfcSE`**: The uncertainty in terms of the standard error (SE) of the log2-fold change estimate\n- **`stat`**: The value for the Wald test's test statistic\n- **`pvalue`**: The *uncorrected* p-value from the Wald test\n- **`padj`**: The multiple-testing corrected p-value (i.e., adjusted p-value)\n\n<details><summary>Are any of the 6 genes shown above differentially expressed?\n&nbsp; <span style=\"color:darkolivegreen;\">{{< fa comments >}}</span>\n</summary></details>\n\n### Log~2~-Fold Changes (LFCs)\n\nIn RNA-Seq analysis,\nlog2-fold changes (LFCs) are the standard way of representing the\n**magnitude (*effect size*) of expression level differences**\nbetween two groups of interest.\nWith A and B being the compared sample groups, the LFC is calculated as\nthe log~2~ transformed ratio of the mean expression levels in each group:\n\n$$ \\log_{2} \\left( \\frac{\\bar{A}}{\\bar{B}} \\right) $$\n\nDue the log-transformation,\nthe LFC also increase more slowly than a raw fold-change:\n\n- An LFC of **`1`** indicates a 2-fold difference\n- An LFC of **`2`** indicates a 4-fold difference\n- An LFC of **`3`** indicates a 8-fold difference\n\nA nice property of LFC is that decreases and increases in expression are expressed symmetrically:\n\n- An LFC of **`1`** means that group A has a **two-fold higher** expression than group B\n- An LFC of **`-1`** means that group A has a **two-fold lower** expression than group B\n\n### Numbers of differentially expressed genes (DEGs)\n\nHow many adjusted p-values were significant (less than 0.05)?\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# (We need 'na.rm = TRUE' because some p-values are 'NA')\n# (If we don't remove NAs from the calculation, sum() will just return NA)\nsum(res_rc1$padj < 0.05, na.rm = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\n[1] 801\n```\n\n\n:::\n:::\n\n\n\n\nThis means that you found 801\nDifferentially Expressed Genes (**DEG**s) for this specific pairwise comparison.\n\n::: exercise\n#### {{< fa user-edit >}} Exercise: DEG numbers\n\nThe paper's Table 1 (which we saw above) reports the number of DEGs for a\nvariety of comparisons.\nHow does the number of DEGs we just got compare to what they found in the paper\nfor this comparison?\n:::\n\n::: exercise\n#### {{< fa user-edit >}} Bonus exercise: Up- and downregulated DEGs\n\n1. The table also reports numbers of up- and downregulated genes separately.\n   Can you get those numbers for your DE results?\n\n<details><summary>*Click to see the solution*</summary>\n\n<hr style=\"height:1pt; visibility:hidden;\" />\n\n- Option 1: Solution using tidyverse/dplyr:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# First convert the results table into a regular data frame:\nas.data.frame(res_rc1) |>\n  # Then, only select the rows/genes that are significant:\n  filter(padj < 0.05) |>\n  # If you run count() on a logical test, you get the nrs. that are FALSE v. TRUE\n  dplyr::count(log2FoldChange > 0)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\n  log2FoldChange > 0   n\n1              FALSE 616\n2               TRUE 185\n```\n\n\n:::\n:::\n\n\n\n\n- Option 2: Solution using base R:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Down-regulated (relictum < control):\nsum(res_rc1$log2FoldChange < 0 & res_rc1$padj < 0.05, na.rm = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\n[1] 616\n```\n\n\n:::\n\n```{.r .cell-code}\n# Up-regulated (relictum > control):\nsum(res_rc1$log2FoldChange > 0 & res_rc1$padj < 0.05, na.rm = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\n[1] 185\n```\n\n\n:::\n:::\n\n\n\n\n</details>\n\n2. The table also reports the number of DEGs with an absolute LFC > 1.\n   Can you get those numbers for your DE results?\n\n<details><summary>*Click to see the solution*</summary>\n<hr style=\"height:1pt; visibility:hidden;\" />\n\n- Option 1: Solution using tidyverse/dplyr:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# First we need to convert the results table into a regular data frame\nas.data.frame(res_rc1) |>\n  # Then we only select the rows/genes that are significant\n  filter(padj < 0.05, abs(log2FoldChange) > 1) |>\n  # If we run count() on a logical test, we get the nrs. that are FALSE v. TRUE\n  dplyr::count(log2FoldChange > 0)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\n  log2FoldChange > 0   n\n1              FALSE 159\n2               TRUE  49\n```\n\n\n:::\n:::\n\n\n\n\n- Option 2: Solution using base R:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Down-regulated (relictum < control):\nsum(res_rc1$log2FoldChange < -1 & res_rc1$padj < 0.05, na.rm = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\n[1] 159\n```\n\n\n:::\n\n```{.r .cell-code}\n# Up-regulated (relictum > control):\nsum(res_rc1$log2FoldChange > 1 & res_rc1$padj < 0.05, na.rm = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\n[1] 49\n```\n\n\n:::\n:::\n\n\n\n</details>\n:::\n\n::: exercise\n#### {{< fa user-edit >}} Bonus exercise: Other pairwise comparisons\nExtract the results for one or more other contrasts in the table,\nand compare the results.\n:::\n\n## DE result visualizations\n\nFinally, you'll create a few plots for the DE results you extracted above.\n\n### Volcano plot\n\n\"Volcano plots\" are a popular way to get a visual overview of DE results.\nYou'll do that here using the `EnhancedVolcano()` function\nfrom the package of the same name\n([see here for a \"vignette\" / tutorial](https://bioconductor.org/packages/release/bioc/vignettes/EnhancedVolcano/inst/doc/EnhancedVolcano.html)):\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nEnhancedVolcano(\n  toptable = res_rc1,       # DESeq2 results to plot   \n  x = \"log2FoldChange\",     # Plot the log2-fold change along the x-axis\n  y = \"padj\",               # Plot the p-value along the y-axis\n  title = \"relictum vs. control at 24 hpi\",  # Plot title\n  lab = rownames(res_rc1),  # Use the rownames for the gene labels (though see below)\n  labSize = 0               # Omit gene labels for now\n  )\n```\n\n::: {.cell-output .cell-output-stderr}\n\n``` warning-r-output\nWarning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.\nℹ Please use `linewidth` instead.\nℹ The deprecated feature was likely used in the EnhancedVolcano package.\n  Please report the issue to the authors.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n``` warning-r-output\nWarning: The `size` argument of `element_line()` is deprecated as of ggplot2 3.4.0.\nℹ Please use the `linewidth` argument instead.\nℹ The deprecated feature was likely used in the EnhancedVolcano package.\n  Please report the issue to the authors.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](DE_files/figure-html/unnamed-chunk-37-1.png){width=85%}\n:::\n:::\n\n\n\n\n::: exercise\n#### {{< fa user-edit >}} Exercise: Interpret the volcano plot\n\nIn the volcano plot, each gene is represented by a point.\nMany points are on top of each other, so it may not look like there's thousand of them.\nThis is not necessarily a problem, because we're most interested in the overall patterns\nand the \"sparser areas\" away from the origin.\n\n1. What is shown along the y-axis? The higher a point is, the more...?\n2. What is shown along the x-axis? The further away from zero a point is, the more...?\n   Why does the x-axis have both negative and positive values?\n3. What do the differently colored quadrants of the plot represent?\n\nBased on the above:\n\n4. Is the pattern with respect to log~2~-fold change symmetric,\n   and if not, what does this mean?\n5. Which points (genes) are the most interesting to follow up on, and why?\n:::\n\n::: exercise\n#### {{< fa user-edit >}} Bonus Exercise: Improve the Volcano Plot\n\nThe `EnhancedVolcano()` function by default adds gene IDs to highly significant\ngenes, but above, we turned off gene name labeling by setting `labSize = 0`.\nI did this because the default p-value cut-off for point labeling is `1e-5` and\nin this case, that would make the plot quite busy with gene labels.\n\nWe might want to try a plot with a stricter p-value cut-off that does show the\ngene labels.\nPlay around with the p-value cut-off and the labeling to create a plot you like.\n\nCheck the package's explanatory\n[\"vignette\"](https://bioconductor.org/packages/release/bioc/vignettes/EnhancedVolcano/inst/doc/EnhancedVolcano.html)\nor the function's help page (accessed by running `?EnhancedVolcano`)\nto see how you can do this.\n\n<details><summary>*Click for an example*</summary>\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nEnhancedVolcano(\n  toptable = res_rc1,      \n  title = \"relictum vs. control at 24 hpi\",\n  x = \"log2FoldChange\",     \n  y = \"padj\",             \n  lab = rownames(res_rc1), \n  labSize = 4,               # Now we will show the gene labels\n  pCutoff = 10e-10,          # Modify the p-value cut-off\n  subtitle = NULL,           # I'll also remove the silly subtitle\n  caption = NULL,            # ... and the caption\n  )\n```\n\n::: {.cell-output-display}\n![](DE_files/figure-html/unnamed-chunk-38-1.png){width=85%}\n:::\n:::\n\n\n\n</details>\n:::\n\n::: exercise\n#### {{< fa user-edit >}} Bonus Exercise: Which gene is the outlier?\n\nOne gene has a _much_ higher log~2~-fold change than all the others.\n\nFigure out the identity of this gene.\nYou can do so either by labeling it in the plot,\nor by filtering the `res_rc1` table.\n\n<details><summary>\n*Click for the solution on how to label it in the plot*\n</summary>\n<hr style=\"height:1pt; visibility:hidden;\" />\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nEnhancedVolcano(\n  toptable = res_rc1,      \n  title = \"relictum vs. control at 24 hpi\",\n  x = \"log2FoldChange\",     \n  y = \"padj\",             \n  lab = rownames(res_rc1), \n  labSize = 4,               \n  pCutoff = 0.05,            # Modify the p-value cut-off\n  FCcutoff = 20,             # Modify the LFC cut-off\n  )\n```\n\n::: {.cell-output .cell-output-stderr}\n\n``` warning-r-output\nWarning: Removed 1 row containing missing values or values outside the scale range\n(`geom_vline()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](DE_files/figure-html/unnamed-chunk-39-1.png){width=85%}\n:::\n:::\n\n\n\n</details>\n\n<details><summary>\n*Click for the solution on how to find it in the results table*\n</summary>\n<hr style=\"height:1pt; visibility:hidden;\" />\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nas.data.frame(res_rc1) |> filter(log2FoldChange > 20)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\n             baseMean log2FoldChange    lfcSE     stat       pvalue\nLOC120431476 39.72038       43.77762 5.301369 8.257795 1.483875e-16\n                     padj\nLOC120431476 3.434281e-13\n```\n\n\n:::\n:::\n\n\n\n\n_(Interestingly, there's a second gene with a LFC \\> 20 that we hadn't seen in the plot,_\n_because it has `NA` as the `pvalue` and `padj`._\n_See the section \"Extra info: `NA` values in the results table\" in the_\n_[Appendix](#appendix-the-de-results) above for why p-values can be set to `NA`.)_\n\n</details>\n:::\n\n### Plot specific genes\n\nIt can also be very informative to plot expression levels for individual genes,\nespecially those with highly significant differential expression.\n\nLet's plot the single most highly significant DEG.\nWe can get the ID of this gene as follows:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Convert the results table into a regular dataframe and sort by adjusted p-value:\ntop_df <- data.frame(res_rc1) |> arrange(padj)\n\n# Gene IDs are the row names: extract the first row name to get the gene of interest\ntop1 <- rownames(top_df)[1]\ntop1\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\n[1] \"LOC120423768\"\n```\n\n\n:::\n:::\n\n\n\n\nDESeq2 also has a built-in gene plotting function.\nThis will by default plot normalized gene counts.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Like with the PlotPCA function, 'intgroup' specifies which variable to use for grouping:\nplotCounts(dds, gene = top1, intgroup = \"group\")\n```\n\n::: {.cell-output-display}\n![](DE_files/figure-html/unnamed-chunk-42-1.png){width=100%}\n:::\n:::\n\n\n\n\n::: {.callout-tip appearance=\"simple\"}\nYou may have to drag the right-hand pane in RStudio way to the left in order\nto see all the x-axis labels...\n:::\n\nIn the above plot,\nwe're not just seeing the difference between `relictum_1` and `control_1`.\nExpression levels are plotted for all treatment-time combinations.\nThat may not always be what you want,\nbut it can be rather useful to see the expression patterns across _all_ groups.\n\n:::: exercise\n#### {{< fa user-edit >}} Exercise: Interpret the expression pattern\n\n1. Does a visual \"sniff test\" support the statistical result that this gene is\n   differentially expressed between `relictum_1` and `control_1`?\n\n2. What other patterns do you see in the expression levels across treatment and time points?\n   Can you think of any biological interpretations for these patterns?\n:::\n\n::: exercise\n#### {{< fa user-edit >}} Exercise: Plot additional DE genes\n\nPlot one or a few more of the top-DE genes.\nDo they have similar expression patterns across treatment and time points as\nthe first one?\n\n<details><summary>*Click for a hint*</summary>\nYou can get the gene IDs of, for example, the second most significant genes\nwith `rownames(top_df)[2]`\n</details>\n:::\n\n::: exercise\n#### {{< fa user-edit >}} Bonus exercise: Plot the outlier gene\n\nPlot the gene with the very high LFC value that you saw when making\nthe volcano plot. How would you interpret this result?\n\n<details><summary>*Click to get the ID of the outlier gene*</summary>\nA previous bonus exercise showed you how to find the ID of the outlier gene.\nIt is: `LOC120431476`.\n</details>\n\n<details><summary>*Click for the solution*</summary>\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplotCounts(dds, gene = \"LOC120431476\", intgroup = \"group\")\n```\n\n::: {.cell-output-display}\n![](DE_files/figure-html/unnamed-chunk-43-1.png){width=100%}\n:::\n:::\n\n\n\n\nWow! It looks like in every single dpi + treatment combination,\nall but one (or in one case, two) of the samples have zero expression,\nbut there are several extreme outliers.\n\nOur focal comparison is `control_1` vs. `relictum_1`,\nand it looks like the difference between these two groups is solely due to the one\noutlier in `relictum`.\nNevertheless, even the multiple-testing corrected p-value (`padj`) is\nsignificant for this gene:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nas.data.frame(res_rc1) |>\n  rownames_to_column(\"gene\") |>\n  filter(gene == \"LOC120431476\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\n          gene baseMean log2FoldChange    lfcSE     stat       pvalue\n1 LOC120431476 39.72038       43.77762 5.301369 8.257795 1.483875e-16\n          padj\n1 3.434281e-13\n```\n\n\n:::\n:::\n\n\n\n\nSo, you have to be careful with talking these statistical results at face value,\nand need to visualize important genes!\n</details>\n::::\n\n::: exercise\n#### {{< fa user-edit >}} Bonus exercise: Make a better-looking plot\n\nThe default `plotCounts()` function creates a rather basic plot.\nCustomize the plot with _ggplot2_ to make it better-looking and clearer.\n\n<details><summary>*Solution part 1: getting the dataframe*</summary>\n\nBelow, you'll use that DESeq2 function, but only to extract the counts for our gene\nof interest in a format for plotting, by adding `returnData = TRUE`:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Use plotCounts with returnData = TRUE just to get a single-gene count table\n# that is suitable for plotting:\nfocal_gene_counts <- plotCounts(\n  dds,\n  gene = top1,\n  intgroup = c(\"dpi\", \"treatment\"),\n  returnData = TRUE\n  )\n\n# Take a look at the resulting dataframe:\nhead(focal_gene_counts)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n``` styled-output\n                 count dpi   treatment\nERR10802863 1543.81532   1     control\nERR10802864 2279.03704   1 cathemerium\nERR10802865   25.42295   1    relictum\nERR10802866 1105.75009   1     control\nERR10802867 1199.28425   1 cathemerium\nERR10802868   32.14394   1    relictum\n```\n\n\n:::\n:::\n\n\n\n\n</details>\n\n<details><summary>*Solution part 2: Making the plot*</summary>\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfocal_gene_counts |>\n  # Treatment along the x-axis, gene counts along the y, color by treatment:\n  ggplot(aes(x = treatment, y = count, fill = treatment)) +\n  # Plot separate \"facets\" with the different time points\n  facet_wrap(vars(dpi)) +\n  # Add a boxplot with a partly transparent (alpha) color:\n  # (Don't show outliers because we'll plot _all_ points next)\n  geom_boxplot(alpha = 0.5, outlier.shape = NA) +\n  # _And_ add individual points (with shape=21 for filled circles):\n  geom_point(size = 4, shape = 21) +\n  # Plot styling (e.g., we don't need a legend)\n  theme_bw() +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](DE_files/figure-html/unnamed-chunk-46-1.png){width=85%}\n:::\n:::\n\n\n\n</details>\n:::\n\n## In Closing\n\nToday, you have performed several steps in the analysis of gene counts that\nresult from a typical RNA-Seq workflow. Specifically, you have:\n\n- Explore the RNA-Seq gene expression data in a DESEq2 object\n- Performed Principal Component Analysis\n- Ran a Differential Expression (DE) analysis with DESeq2\n- Extracted, interpreted, and visualized the DE results\n\n#### What would be the next steps in such an analysis?\n\nTypical next steps in such an analysis include:\n\n- Additional summaries and plots can be made, such as heatmaps (see the Appendix below)\n- Extracting, comparing, and synthesizing DE results across **all pairwise comparisons**\n  (this would for example allow us to make the upset plot in *Figure 2 of the paper*)\n- **Functional enrichment analysis** with Gene Ontology (GO) terms,\n  as done in the paper, and/or with KEGG pathways.\n\n<br>\n\n-----\n\n## Appendix\n\n### A heatmap\n\nRather than plotting expression levels for many individual genes,\nyou can create \"heatmap\" plots to plot dozens (possibly even hundreds) of genes at once.\n\nWe will create heatmaps with the `pheatmap` function,\nand let's make a heatmap for the top-25 most highly significant DEGs for the\nfocal contrast. First, let's install and then load this package:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Install the pheatmap package [Output not shown]:\ninstall.packages(\"pheatmap\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load the pheatmap package:\nlibrary(pheatmap)\n```\n:::\n\n\n\n\nUnlike with some of the functions we used before,\nwe unfortunately can't directly use our DESeq2 object,\nbut we have to extract and subset the count matrix,\nand also pass the metadata to the heatmap function:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# You need a normalized count matrix, like for the PCA\n# You can extract the matrix from the normalized dds object we created for the PCA\n# with the assay() function\nnorm_mat <- assay(dds_vst)\n\n# In the normalized count matrix, select only the genes of interest\n# We'll create a vector with the top256 most significant DEGs\ntop25_DE <- rownames(top_df)[1:25]\nnorm_mat_sel <- norm_mat[match(top25_DE, rownames(norm_mat)), ]\n```\n:::\n\n\n\n\nThe plot will respect the order of samples in the count matrix,\nso let's sort the metadata and then the count matrix sensibly:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Sort the metadata\nmeta_sort <- meta |> arrange(treatment, dpi)\n\n# Sort the columns in the normalized count matrix to match the metadata\nnorm_mat_sel <- norm_mat_sel[, rownames(meta_sort)]\n```\n:::\n\n\n\n\nNow you can create the plot:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npheatmap(\n  norm_mat_sel,\n  annotation_col = meta_sort,  # Add the metadata\n  cluster_cols = FALSE,        # Don't cluster samples (=columns, cols)\n  show_rownames = FALSE,       # Don't show gene names\n  scale = \"row\",               # Perform z-scaling for each gene\n  )\n```\n\n::: {.cell-output-display}\n![](DE_files/figure-html/unnamed-chunk-51-1.png){width=85%}\n:::\n:::\n\n\n\n\n::: {.callout-tip appearance=\"simple\"}\n- The z-scaling with `scale =` will make sure we can compare genes with\n  very different expression levels: after all,\n  we're interested in relative expression levels across samples/sample groups\n\n- `pheatmap` will by default perform hierarchical clustering both at the sample\n  (`col`) and gene (`row`) level,\n  such that more similar samples and genes will appear closer to each other.\n  Above, we turned clustering off for samples to keep them in their groupwise order.\n:::\n\n::: exercise\n#### {{< fa user-edit >}} Bonus Exercise\n\nMake a heatmap with the top-25 **most-highly expressed** genes\n(i.e., genes with the highest mean expression levels across all samples).\n\n<details><summary>*Click for a hint: how to get that top-25*</summary>\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntop25_hi <- names(sort(rowMeans(norm_mat), decreasing = TRUE)[1:25])\n```\n:::\n\n\n\n</details>\n\n<details><summary>*Click for the solution*</summary>\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# In the normalized count matrix, select only the genes of interest\nnorm_mat_sel <- norm_mat[match(top25_hi, rownames(norm_mat)), ]\n\n# Sort the metadata\nmeta_sort <- meta |>\n  arrange(treatment, dpi) |>\n  select(treatment, dpi)\n\n# Create the heatmap\npheatmap(\n  norm_mat_sel,\n  annotation_col = meta_sort,\n  cluster_cols = FALSE,\n  show_rownames = FALSE,\n  scale = \"row\"\n  )\n```\n\n::: {.cell-output-display}\n![](DE_files/figure-html/unnamed-chunk-53-1.png){width=85%}\n:::\n:::\n\n\n\n\n</details>\n:::\n\n### Exporting the results\n\nYou may be wondering how you can save the DE results tables to files.\nYou can do this with the function `write_tsv()`.\nThis stores the table to a TSV text file, which can be opened in Excel. \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Write the results table to a TSV file:\nwrite_tsv(as.data.frame(res_rc1), \"DE-results_rc1.tsv\")\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}